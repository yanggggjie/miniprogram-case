<view class="page">
  <block wx:if="{{!isFixMode}}">
    <scroll-view
      class="scroll-area"
      style="height: {{scrollViewHeight}}px;"
      scroll-y="{{true}}"
      upper-threshold="50"
      bindscrolltoupper="onScrollToUpperBuggy"
      scroll-anchoring="{{true}}"
      bounces="{{false}}"
      enhanced="{{true}}"
    >
      <view wx:if="{{loadingMore}}" class="loading-area">加载中...</view>
      <view wx:for="{{msgList}}" wx:key="id" class="msg-row {{item.isMe ? 'msg-right' : 'msg-left'}}">
        <view class="avatar {{item.isMe ? 'avatar-me' : 'avatar-other'}}">{{item.isMe ? '我' : 'Ta'}}</view>
        <view class="msg-bubble {{item.isMe ? 'bubble-me' : 'bubble-other'}}">{{item.text}}</view>
      </view>
    </scroll-view>
  </block>

  <block wx:elif="{{isFixMode}}">
    <scroll-view
      class="scroll-area"
      style="height: {{scrollViewHeight}}px;"
      scroll-y="{{scrollY}}"
      scroll-top="{{scrollTop}}"
      scroll-with-animation="{{scrollWithAnimation}}"
      upper-threshold="50"
      bindscrolltoupper="onScrollToUpperFix"
      bindscroll="onScroll"
      throttle="{{false}}"
      scroll-anchoring="{{true}}"
      bounces="{{false}}"
      enhanced="{{true}}"
    >
      <view wx:if="{{loadingMore}}" class="loading-area">加载中...</view>
      <view wx:for="{{msgList}}" wx:key="id" class="msg-row {{item.isMe ? 'msg-right' : 'msg-left'}}">
        <view class="avatar {{item.isMe ? 'avatar-me' : 'avatar-other'}}">{{item.isMe ? '我' : 'Ta'}}</view>
        <view class="msg-bubble {{item.isMe ? 'bubble-me' : 'bubble-other'}}">{{item.text}}</view>
      </view>
    </scroll-view>

    <!-- 预渲染区域：在 scroll-view 外部，不可见，用于测量新消息高度 -->
    <view class="temp-chat-area" wx:if="{{tempMsgList.length > 0}}">
      <view wx:for="{{tempMsgList}}" wx:key="id" class="msg-row {{item.isMe ? 'msg-right' : 'msg-left'}}">
        <view class="avatar {{item.isMe ? 'avatar-me' : 'avatar-other'}}">{{item.isMe ? '我' : 'Ta'}}</view>
        <view class="msg-bubble {{item.isMe ? 'bubble-me' : 'bubble-other'}}">{{item.text}}</view>
      </view>
    </view>
  </block>

  <view class="float-btn" bindtap="toggleMode">{{isFixMode ? "bug" : "fix"}}</view>
</view>
